---
title: "Demographics"
author: "Christopher Huebel, Helena Davies, Dina Monssen"
date: "2022-08-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Clear Global Environment
```{r clear global environment}
rm(list = ls(all.names = TRUE)) 
```

Read in file with path to data channel
```{r Read in file with path to data channel on teams}
source(file = "../credentials/paths.R")
```

Add the add_numeric function - used to convert character variables into numeric variables
Add the remove_duplicates function - used to deduplicate and remove NAs from IDs
Add the sumscores function - used to generate sumscores
Add the package_check function - used to install and load dependencies
Add the imp_check function - used to check variables for implausible values
```{r Read in functions}
source(file = paste0(ilovedata_scripts, "functions/add_numeric.R"))
source(file = paste0(ilovedata_scripts, "functions/remove_duplicates.R"))
source(file = paste0(ilovedata_scripts, "functions/sumscores.R"))
source(file = paste0(ilovedata_scripts, "functions/package_check.R"))
source(file = paste0(ilovedata_scripts, "functions/imp_check.R"))
source(file = paste0(ilovedata_scripts, "functions/recode_check.R"))
```

Load packages
```{r Load packages}
library(tidyverse)
library(flextable)
library(officer)
library(gtsummary)
```

Set current date
```{r current date}
date <- Sys.Date()
```

Load data
```{r Load data}
load(file = paste0(filepath_cleaned_data, "tables.Rdata"))
```

```{r}
names(selfreport_algo_sex)
```

# Table of frequency of eating disorder
```{r table freq EDs}
dat_eds_binary_numeric <- dat %>%
  select(
    "Anorexia nervosa" = anorexia_nervosa_subtype_numeric,
    "Bulimia nervosa" = bulimia_nervosa_numeric,
    "Binge-eating disorder" = binge_eating_disorder_numeric,
    "Purging disorder" = purging_disorder_numeric,
    "Atypical anorexia nervosa" = atypical_anorexia_nervosa_numeric,
    "Atypical binge-eating disorder" = atypical_binge_eating_disorder_numeric,
    "Atypical bulimia nervosa" = atypical_bulimia_nervosa_numeric,
    "Night-eating syndrome" = night_eating_syndrome_numeric,
    "Pica" = pica_numeric,
    "Avoidant/restrictive food intake disorder" = avoidant_restrictive_food_intake_disorder_numeric,
    "Rumination disorder" = rumination_disorder_numeric
  ) %>%
  gtsummary::tbl_summary(missing = "no")

dat_eds_binary_numeric
```

# Table of frequency of eating disorder by sex
```{r table freq EDs}
dat_eds_binary_sex_numeric <- dat %>%
  select(
    "Anorexia nervosa" = anorexia_nervosa_subtype_numeric,
    "Bulimia nervosa" = bulimia_nervosa_numeric,
    "Binge-eating disorder" = binge_eating_disorder_numeric,
    "Purging disorder" = purging_disorder_numeric,
    "Atypical anorexia nervosa" = atypical_anorexia_nervosa_numeric,
    "Atypical binge-eating disorder" = atypical_binge_eating_disorder_numeric,
    "Atypical bulimia nervosa" = atypical_bulimia_nervosa_numeric,
    "Night-eating syndrome" = night_eating_syndrome_numeric,
    "Pica" = pica_numeric,
    "Avoidant/restrictive food intake disorder" = avoidant_restrictive_food_intake_disorder_numeric,
    "Rumination disorder" = rumination_disorder_numeric,
    sex
  ) %>%
  gtsummary::tbl_summary(missing = "no",
                         by = sex)


dat_eds_binary_sex_numeric
```

```{r upset plot, fig.height=6, fig.width=7}
# Create numeric binary variables needed
dat <- dat %>% 
  mutate(ed.DSM5_AN_binge_purge_binary_numeric = 
    case_when(ed.DSM5_AN_binge_purge_binary == "DSM5 AN binge eating/purging" ~ 1,
         TRUE ~ 0
    )
  )

dat <- dat %>% 
  mutate(ed.DSM5_AN_restricting_binary_numeric = 
    case_when(ed.DSM5_AN_restricting_binary == "DSM5 AN restricting" ~ 1,
        TRUE ~ 0
    )
  )


dat <- dat %>% 
  mutate(anorexia_nervosa_subtype_unknown_numeric = 
    case_when(anorexia_nervosa_subtype_numeric == "Unknown subtype" ~ 1,
         
              TRUE~ 0
    )
  )


dat_upset <- dat %>% 
   select(
     "Anorexia nervosa restricting" = ed.DSM5_AN_restricting_binary_numeric,
     "Anorexia nervosa binge-eating/purging" = ed.DSM5_AN_binge_purge_binary_numeric,
     "Anorexia nervosa (subtype unknown)" = anorexia_nervosa_subtype_unknown_numeric,
    "Bulimia nervosa" = bulimia_nervosa_numeric,
    "Binge-eating disorder" = binge_eating_disorder_numeric,
    "Purging disorder" = purging_disorder_numeric,
    "Atypical anorexia nervosa" = atypical_anorexia_nervosa_numeric,
    "Atypical binge-eating disorder" = atypical_binge_eating_disorder_numeric,
    "Atypical bulimia nervosa" = atypical_bulimia_nervosa_numeric,
    "Night-eating syndrome" = night_eating_syndrome_numeric,
    "Pica" = pica_numeric,
    "Avoidant/restrictive food intake disorder" = avoidant_restrictive_food_intake_disorder_numeric,
    "Rumination disorder" = rumination_disorder_numeric,
   ) %>%
  as.data.frame()

png(file = "../../results/main_manuscript/EDGI_upsetR_plot_for_manuscript.png",
    width = 1000,
    height = 500)

UpSetR::upset(dat_upset,
              sets = c("Anorexia nervosa (subtype unknown)",
                      "Anorexia nervosa restricting",
                      "Anorexia nervosa binge-eating/purging",
    "Bulimia nervosa",
    "Binge-eating disorder",
    "Purging disorder",
    "Atypical anorexia nervosa" ,
    "Atypical binge-eating disorder",
    "Atypical bulimia nervosa",
    "Night-eating syndrome",
    "Pica",
    "Avoidant/restrictive food intake disorder",
    "Rumination disorder"),
        nintersects = 60, # Limit to intersections with 5 or more participants
    order.by = "freq"
    ) 


dev.off()

?upset
```

```{r modify labls and run table}
dat_eds_binary_sex_numeric_mod <- dat_eds_binary_sex_numeric %>% 
  bold_labels() 
```

Save as a word document
```{r word properties}
sect_properties <- officer::prop_section(
  page_size = page_size(
    orient = "landscape",
    width = 8.3, height = 11.7
  ),
  type = "continuous",
  page_margins = page_mar()
)
```

```{r summary_table_long as word document}
dat_eds_binary_sex_numeric_mod %>%
  as_flex_table() %>%
  flextable::save_as_docx(
    path = "../../results/main_manuscript/EDGI_diagnosis_by_sex_for_manuscript.docx",
    pr_section = sect_properties
  )
```
